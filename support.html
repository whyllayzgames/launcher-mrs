<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Assistance MRS - Joueur</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 20px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }

    p {
      margin: 0 0 10px 0;
      color: #9ca3af;
    }

    .layout {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin-top: 20px;
      min-height: 0;
      gap: 16px;
    }

    .card {
      padding: 16px;
      border-radius: 10px;
      background: #0b1120;
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .card h2 {
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 8px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      margin-bottom: 10px;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    button {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      min-height: 18px;
    }

    .status.ok {
      color: #22c55e;
    }

    .status.err {
      color: #ef4444;
    }

    .section-title {
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: bold;
      color: #e5e7eb;
    }

    .small {
      font-size: 12px;
      color: #9ca3af;
    }

    .tickets-list {
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 8px;
      max-height: 180px;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    .ticket-item {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020617;
      margin-bottom: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .ticket-item:hover {
      background: #111827;
    }

    .ticket-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ticket-item-pseudo {
      font-weight: bold;
    }

    .ticket-item-type {
      font-size: 11px;
      color: #9ca3af;
    }

    .badge-status {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }

    .badge-ouvert {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .badge-en_cours {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
    }

    .badge-clos {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .chat-box {
      flex: 1;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 8px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 8px;
      padding-right: 4px;
    }

    .chat-message {
      margin-bottom: 6px;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 13px;
      max-width: 100%;
    }

    .msg-user {
      background: rgba(37, 99, 235, 0.15);
      align-self: flex-start;
    }

    .msg-staff {
      background: rgba(34, 197, 94, 0.15);
      align-self: flex-end;
    }

    .chat-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .chat-input-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .chat-input-row textarea {
      margin-bottom: 0;
      min-height: 60px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Assistance MRS</h1>
    <p>Ouvre un ticket pour contacter le support. Suis ensuite la discussion directement depuis le launcher.</p>
  </header>

  <div class="layout">
    <div class="card">
      <h2>Créer un ticket</h2>
      <form id="ticketForm">
        <label for="pseudo">Pseudo en jeu / Steam *</label>
        <input id="pseudo" name="pseudo" type="text" required placeholder="Ex : MRS_Ewen">

        <label for="type">Type de demande *</label>
        <select id="type" name="type" required>
          <option value="">-- Sélectionne une catégorie --</option>
          <option value="bug">Bug / Problème technique</option>
          <option value="compte">Problème de compte / connexion</option>
          <option value="sanction">Question sur une sanction</option>
          <option value="autre">Autre demande</option>
        </select>

        <label for="message">Décris ton problème *</label>
        <textarea id="message" name="message" required placeholder="Explique ton problème, ce que tu faisais, les messages d’erreur, etc."></textarea>

        <button type="submit" id="submitBtn">Envoyer le ticket</button>
        <div id="status" class="status"></div>
      </form>
    </div>

    <div class="card" style="flex: 1;">
      <h2>Suivi de mes tickets</h2>

      <div class="section-title">Mes tickets</div>
      <div class="small">
        Saisis ton pseudo (le même que pour la création du ticket), puis clique sur “Charger mes tickets”.
      </div>

      <div style="display:flex; gap:6px; margin-top:8px; margin-bottom:8px;">
        <input id="userTicketsPseudo" type="text" placeholder="Pseudo joueur">
        <button type="button" id="loadUserTicketsBtn">Charger mes tickets</button>
      </div>

      <div class="tickets-list" id="userTicketsList"></div>

      <div class="section-title">Détail du ticket sélectionné</div>
      <div class="chat-box" id="userChatBox">
        <div class="chat-messages" id="userChatMessages">
          <div class="small">Sélectionne un ticket dans “Mes tickets” pour voir la conversation.</div>
        </div>
        <div class="chat-input-row">
          <textarea id="userReplyText" placeholder="Écrire une réponse..."></textarea>
          <button type="button" id="userReplyBtn">Envoyer</button>
        </div>
        <div id="userChatStatus" class="status"></div>
      </div>
    </div>
  </div>

  <script>
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return '';
      return d.toLocaleString();
    }

    function statusLabel(status) {
      switch (status) {
        case 'ouvert': return 'Ouvert';
        case 'en_cours': return 'En cours';
        case 'clos': return 'Clos';
        default: return status || 'Inconnu';
      }
    }

    function statusClass(status) {
      if (status === 'ouvert') return 'badge-ouvert';
      if (status === 'en_cours') return 'badge-en_cours';
      if (status === 'clos') return 'badge-clos';
      return '';
    }

    // --- Formulaire joueur ---
    const form = document.getElementById('ticketForm');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    const userTicketsPseudoInput = document.getElementById('userTicketsPseudo');
    const loadUserTicketsBtn = document.getElementById('loadUserTicketsBtn');
    const userTicketsListEl = document.getElementById('userTicketsList');
    const userChatMessages = document.getElementById('userChatMessages');
    const userReplyText = document.getElementById('userReplyText');
    const userReplyBtn = document.getElementById('userReplyBtn');
    const userChatStatus = document.getElementById('userChatStatus');

    let currentUserTickets = [];
    let currentUserTicketId = null;

    function setStatus(message, type) {
      statusEl.textContent = message || '';
      statusEl.className = 'status ' + (type || '');
    }

    function setUserChatStatus(message, type) {
      userChatStatus.textContent = message || '';
      userChatStatus.className = 'status ' + (type || '');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const pseudo = document.getElementById('pseudo').value.trim();
      const type = document.getElementById('type').value;
      const message = document.getElementById('message').value.trim();

      if (!pseudo || !type || !message) {
        setStatus('Merci de remplir tous les champs obligatoires (*).', 'err');
        return;
      }

      const ticket = { pseudo, type, message };

      submitBtn.disabled = true;
      setStatus('Envoi du ticket en cours...', '');

      try {
        const res = await window.launcherAPI?.submitTicket(ticket);

        if (res && res.ok) {
          setStatus('✅ Ticket envoyé. Il sera traité par le staff.', 'ok');
          form.reset();

          userTicketsPseudoInput.value = pseudo;
          await loadUserTickets();
        } else {
          setStatus('❌ Erreur lors de l’envoi du ticket.', 'err');
        }
      } catch (err) {
        console.error(err);
        setStatus('❌ Erreur inattendue. Vérifie ta connexion.', 'err');
      } finally {
        submitBtn.disabled = false;
      }
    });

    async function loadUserTickets() {
      const pseudo = userTicketsPseudoInput.value.trim();
      if (!pseudo) {
        userTicketsListEl.innerHTML = '<div class="small">Saisis ton pseudo pour voir tes tickets.</div>';
        return;
      }

      if (!window.launcherAPI?.getUserTickets) return;

      userTicketsListEl.innerHTML = 'Chargement...';

      try {
        const res = await window.launcherAPI.getUserTickets(pseudo);
        if (!res || !res.ok) {
          userTicketsListEl.innerHTML = '<div class="small">Erreur lors du chargement de tes tickets.</div>';
          return;
        }

        const tickets = res.tickets || [];
        currentUserTickets = tickets;

        if (tickets.length === 0) {
          userTicketsListEl.innerHTML = '<div class="small">Aucun ticket trouvé pour ce pseudo.</div>';
          userChatMessages.innerHTML = '<div class="small">Sélectionne un ticket dans “Mes tickets” pour voir la conversation.</div>';
          return;
        }

        userTicketsListEl.innerHTML = '';
        tickets.forEach(ticket => {
          const item = document.createElement('div');
          item.className = 'ticket-item';
          item.addEventListener('click', () => {
            openUserTicket(ticket.id);
          });

          const header = document.createElement('div');
          header.className = 'ticket-item-header';

          const left = document.createElement('div');
          const pseudoEl = document.createElement('div');
          pseudoEl.className = 'ticket-item-pseudo';
          pseudoEl.textContent = `#${ticket.id} - ${ticket.type || 'Autre'}`;

          const dateEl = document.createElement('div');
          dateEl.className = 'ticket-item-type';
          dateEl.textContent = formatDate(ticket.createdAt);

          left.appendChild(pseudoEl);
          left.appendChild(dateEl);

          const statusBadge = document.createElement('div');
          statusBadge.className = 'badge-status ' + statusClass(ticket.status);
          statusBadge.textContent = statusLabel(ticket.status);

          header.appendChild(left);
          header.appendChild(statusBadge);

          item.appendChild(header);
          userTicketsListEl.appendChild(item);
        });

      } catch (e) {
        console.error(e);
        userTicketsListEl.innerHTML = '<div class="small">Erreur lors du chargement de tes tickets.</div>';
      }
    }

    loadUserTicketsBtn.addEventListener('click', () => {
      loadUserTickets();
    });

    async function openUserTicket(ticketId) {
      currentUserTicketId = ticketId;
      setUserChatStatus('', '');

      if (!window.launcherAPI?.getTicket) return;

      userChatMessages.innerHTML = 'Chargement du ticket...';

      try {
        const res = await window.launcherAPI.getTicket(ticketId);
        if (!res || !res.ok || !res.ticket) {
          userChatMessages.innerHTML = '<div class="small">Impossible de charger ce ticket.</div>';
          return;
        }

        const ticket = res.ticket;
        renderChatMessages(ticket, userChatMessages);

        if (ticket.status === 'clos') {
          setUserChatStatus('Ce ticket est clos. Tu ne peux plus répondre.', 'err');
        } else {
          setUserChatStatus('Tu peux répondre à ce ticket.', 'ok');
        }
      } catch (e) {
        console.error(e);
        userChatMessages.innerHTML = '<div class="small">Erreur lors du chargement du ticket.</div>';
      }
    }

    userReplyBtn.addEventListener('click', async () => {
      if (!currentUserTicketId) {
        setUserChatStatus('Sélectionne d’abord un ticket.', 'err');
        return;
      }

      const msg = userReplyText.value.trim();
      if (!msg) {
        setUserChatStatus('Message vide.', 'err');
        return;
      }

      if (!window.launcherAPI?.addTicketResponse) return;

      userReplyBtn.disabled = true;
      setUserChatStatus('Envoi de la réponse...', '');

      try {
        const pseudo = userTicketsPseudoInput.value.trim() || 'Joueur';
        const res = await window.launcherAPI.addTicketResponse(currentUserTicketId, 'user', pseudo, msg);

        if (!res || !res.ok) {
          setUserChatStatus('Erreur lors de l’envoi de la réponse.', 'err');
          userReplyBtn.disabled = false;
          return;
        }

        userReplyText.value = '';
        const refreshed = await window.launcherAPI.getTicket(currentUserTicketId);
        if (refreshed && refreshed.ok && refreshed.ticket) {
          renderChatMessages(refreshed.ticket, userChatMessages);
          setUserChatStatus('Réponse envoyée.', 'ok');
        }

      } catch (e) {
        console.error(e);
        setUserChatStatus('Erreur inattendue.', 'err');
      } finally {
        userReplyBtn.disabled = false;
      }
    });

    function renderChatMessages(ticket, container) {
      container.innerHTML = '';

      const headerInfo = document.createElement('div');
      headerInfo.className = 'small';
      headerInfo.style.marginBottom = '6px';
      headerInfo.textContent = `Ticket #${ticket.id} — Statut : ${statusLabel(ticket.status)} — Joueur : ${ticket.pseudo || 'Inconnu'}`;
      container.appendChild(headerInfo);

      const responses = Array.isArray(ticket.responses) ? ticket.responses : [];

      if (responses.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'small';
        empty.textContent = 'Aucun message pour ce ticket.';
        container.appendChild(empty);
        return;
      }

      responses.forEach(r => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message ' + (r.from === 'staff' ? 'msg-staff' : 'msg-user');

        const meta = document.createElement('div');
        meta.className = 'chat-meta';
        meta.textContent = `${r.author || (r.from === 'staff' ? 'Staff' : 'Joueur')} — ${formatDate(r.date)}`;

        const text = document.createElement('div');
        text.textContent = r.message || '';

        msgDiv.appendChild(meta);
        msgDiv.appendChild(text);

        container.appendChild(msgDiv);
      });

      container.scrollTop = container.scrollHeight;
    }
  </script>
</body>
</html>
